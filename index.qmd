```{r}
#| label: setup
#| include: false

source(here::here("R", "_setup.R"))
```

## Overview

This report explores potential associations between childhood undernutrition and the Standardized Precipitation Evapotranspiration Index ([SPEI](https://en.wikipedia.org/wiki/Standardised_Precipitation_Evapotranspiration_Index)) in Brazilian municipalities (2008–2019). It is part of the [Sustentarea](https://www.fsp.usp.br/sustentarea) Research and Extension Group's project titled *Global syndemic: The impact of anthropogenic climate change on the health and nutrition of children under five years old served by Brazil's public health system (SUS)*.

::: {.callout-warning}
Please note that this report is designed to support decision-making and may not include all the details of the analysis.
:::

## Methods

### Approach and Procedure Method

The analysis was conducted using Generalized Additive Models ([GAMs](https://en.wikipedia.org/wiki/Generalized_additive_model)) to model and control for potential effects, alongside visual inspections of the data. Results are also presented for each cluster of the Revised Multidimensional Index for Sustainable Food Systems (MISFS-R) [@carvalho2021a; @norde2023].

Any additional analyses or updates will be incorporated into this report in future revisions, if necessary.

### Source of Data/Information

The data used in this analysis have as sources:

- The Brazilian Institute of Geography and Statistics ([IBGE](https://www.ibge.gov.br/)) Automatic Retrieval System ([SIDRA](https://sidra.ibge.gov.br/)), for data on GDP per capita.
- Brazil's Food and Nutrition Surveillance System ([SISVAN](https://sisaps.saude.gov.br/sisvan/)), for data on malnutrition.
- [WorldClim](https://worldclim.org/data/index.html), for data on bioclimatic variables, which allowed us to calculate the Standardised Precipitation Evapotranspiration Index (SPEI) for municipalities in Brazil.

The data files can be found in the [data](https://github.com/sustentarea/gs-data-analysis-report-3/tree/main/data) directory of the code repository.

### Data Wrangling

The data wrangling and analysis followed the data science framework outlined by @wickham2023e, as illustrated in [@fig-wickham-at-al-2024-figure-1].

::: {#fig-wickham-at-al-2024-figure-1}
![](images/wickham-at-al-2024-figure-1.png){width=75%}

[Source: Reproduced from @wickham2023e.]{.legend}

Model of the data science process created by Wickham, Çetinkaya-Runde, and Grolemund.
:::

All the analyses are 100% reproducible and can be run again at any time. See the [README](https://github.com/sustentarea/gs-data-analysis-report-3/blob/main/README.md) file on the code repository to learn how to run them.

### Interpretation of Results

#### Standardized Precipitation Evapotranspiration Index (SPEI)

Since the original SPEI authors [@vicente-serrano2010] did not establish definitive thresholds for SPEI values and their corresponding drought conditions, we adopt the benchmark values provided by @mehr2020 [@tbl-mehr-et-al-2020-table-2].

::: {#tbl-mehr-et-al-2020-table-2}
| Classification         | SPI Threshold      | SPEI Threshold     |
|-------------------------|--------------------|--------------------|
| Extremely wet          | 2.0 ≤ SPI          | 1.83 ≤ SPEI        |
| Severely wet           | 2.0 > SPI ≥ 1.5    | 1.82 > SPEI ≥ 1.43 |
| Moderately wet         | 1.49 > SPI ≥ 1.0   | 1.42 > SPEI ≥ 1.0  |
| Near normal            | -1.0 ≤ SPI ≤ 1.0   | -1.0 ≤ SPEI ≤ 1.0  |
| Moderate drought (MoD) | -1.49 ≤ SPI < -1.0 | -1.42 ≤ SPEI < -1.0|
| Severe drought (SD)    | -2.0 ≤ SPI < -1.5  | -1.82 ≤ SPEI < -1.43|
| Extreme drought (ED)   | SPI < -2.0         | SPEI < -1.83       |

[Source: Reproduced from @mehr2020.]{.legend}

Classifications of wet and dry conditions using SPI and SPEI indices.
:::

#### Revised Multidimensional Index for Sustainable Food Systems (MISFS-R)

The Multidimensional Index for Sustainable Food Systems (MISFS) is a tool designed to measure the sustainability of food systems at a subnational level, specifically created for Brazil, taking into account local behaviours and practices. The MISFS-R is a revised version of the MISFS, which includes new indicators and a new methodology for calculating the index [@fig-norde-2023-figure-6]. See @carvalho2021a and @norde2023 to learn more.

::: {#fig-norde-2023-figure-6}
![](images/norde-2023-figure-6.jpg){width=90%}

[Source: Reproduced from @norde2023.]{.legend}

Dendrogram for cluster analysis between Brazilian states considering all the Revised Multidimensional Index for Sustainable Food Systems (MISFS-R) indicators and geographical location of each cluster.
:::

#### Pratical Significance

To ensure practical significance, the adjusted $\text{R}^2$ of the models are analysed for their effect sizes considering a confidence interval of $0.95$. We use @cohen1988a benchmark for interpretation.

A $\text{R}^2$ less than $\approx 0.0196$ is considered negligeble. Please note the following excerpts from @cohen1988a:

> SMALL EFFECT SIZE: $f^2 = .02$. Translated into $\text{R}^{2}$ or partial $\text{R}^{2}$ for Case 1, this gives $.02 / (1 + .02) = .0196$. We thus define a small effect as one that accounts for 2% of the $\text{Y}$ variance (in contrast with 1% for $r$), and translate to an $\text{R} = \sqrt{0196} = .14$ (compared to .10 for $r$). This is a modest enough amount, **just barely escaping triviality** and (alas!) all too frequently in practice represents the true order of magnitude of the effect being tested [@cohen1988a, p. 413].

> [...] in many circumstances, all that is intended by "proving" the null hypothesis is that the ES [Effect Size] is not necessarily zero but **small enough to be negligible** [...]. [@cohen1988a, p. 461].

## Setting the Enviroment

```{r}
#| eval: false

library(beepr)
library(broom)
library(cli)
library(dplyr)
library(effectsize)
library(ggplot2)
library(glmmTMB)
library(janitor)
library(lme4)
library(magrittr)
library(mgcv)
library(MuMIn)
library(patchwork)
library(performance)
library(polyglotr)
library(prettycheck) # github.com/danielvartan/prettycheck
library(psychometric)
library(purrr)
library(r2glmm)
library(readxl)
library(rutils) # github.com/danielvartan/rutils
library(sidrar)
library(stats)
library(stringr)
library(tidyr)
```

```{r}
#| include: false

library(magrittr)
library(mgcv)
library(ggplot2)
```

```{r}
source(here::here("R", "coef_mean.R"))
source(here::here("R", "get_and_aggregate_sidra_by_year.R"))
source(here::here("R", "model_gamm_misfs.R"))
source(here::here("R", "plot_gamm.R"))
source(here::here("R", "utils.R"))
source(here::here("R", "utils-plots.R"))
```

## Importing and Tidying the Data

### Nutrition Data

```{r}
#| eval: false
#| include: false

test_nutrition_data <-
  here::here("data", "Banco_dados_malnutritio_clima - Adaptado.csv") |>
  readr::read_csv(col_types = readr::cols(.default = "c")) |>
  janitor::clean_names() |>
  dplyr::rename(
    year = ano,
    municipality_code = code_muni,
  ) |>
  dplyr::select(year, municipality_code, mbepr, beipr, maper, mpepr) |>
  dplyr::mutate(
    dplyr::across(
      .cols = -dplyr::all_of(c("year", "municipality_code")),
      .fns = as.numeric
    ),
    dplyr::across(
      .cols = dplyr::all_of(c("year", "municipality_code")),
      .fns = as.integer
    )
  )
```

```{r}
#| output: false

nutrition_data <-
  here::here("data", "Banco_dados_malnutritio_clima - Adaptado.csv") |>
  readr::read_csv(col_types = readr::cols(.default = "c")) |>
  janitor::clean_names() |>
  dplyr::rename(
    year = ano,
    municipality_code = code_muni,
    sisvan_cover = cobrs,
    number_of_children = n_ao_de_criana_as_municipio_x,
    n_mbepr = muito_baixa_e_i_n_x,
    n_beipr = baixa_e_i_n_x,
    n_maper = magreza_acentuada_p_e_n_x,
    n_mpepr = magreza_p_e_n_x
  ) |>
  dplyr::select(
    year, municipality_code, misf, number_of_children, sisvan_cover,
    n_mbepr, n_beipr, n_maper, n_mpepr
  ) |>
  dplyr::mutate(
    dplyr::across(
      .cols = dplyr::all_of(
        c("number_of_children", "n_mbepr", "n_beipr", "n_maper", "n_mpepr")
      ),
      .fns = ~ 
        dplyr::case_when(
          !(as.numeric(.x) %% 1 == 0) ~ stringr::str_remove(.x, "\\."),
          TRUE ~ .x
        ) |>
        as.integer()
    )
  ) |>
  dplyr::filter(
    sisvan_cover < 1,
    number_of_children > n_mbepr,
    number_of_children > n_beipr,
    number_of_children > n_maper,
    number_of_children > n_mpepr
  ) |>
  dplyr::mutate(
    year = as.integer(year),
    municipality_code = as.integer(municipality_code),
    sisvan_cover = as.numeric(sisvan_cover),
    mbepr = n_mbepr,
    beipr = n_beipr,
    n_mbepr_beipr = n_mbepr + n_beipr,
    mbepr_beipr = n_mbepr_beipr,
    maper = n_maper,
    mpepr = n_mpepr,
    n_maper_mpepr = n_maper + n_mpepr,
    maper_mpepr = n_maper_mpepr
  ) |>
  dplyr::mutate(
    dplyr::across(
      .cols = dplyr::all_of(
        c("mbepr", "beipr", "mbepr_beipr", "maper", "mpepr", "maper_mpepr")
      ),
      .fns = ~
        .x  %>%
      `/`(number_of_children * sisvan_cover)
    ),
    dplyr::across(
      .cols = dplyr::all_of(
        c("mbepr", "beipr", "mbepr_beipr", "maper", "mpepr", "maper_mpepr")
      ),
      .fns = ~ pmax(0.00001, pmin(.x, 0.99999))
    )
  ) |>
  dplyr::select(
    year, municipality_code, misf, number_of_children, sisvan_cover, 
    n_mbepr, mbepr, n_beipr, beipr, n_mbepr_beipr, mbepr_beipr,
    n_maper, maper, n_mpepr, mpepr, n_maper_mpepr, maper_mpepr
  )
```

```{r}
#| eval: false
#| include: false

var <- "maper"
diff <- (nutrition_data[[var]] - test_nutrition_data[[var]])

summary(diff)
diff |> hist(breaks = seq(-1, 1, 0.01))
```

### GDP Per Capita Data

```{r}
#| evel: false
#| output: false

gdp_data <- 
  here::here("data", "PIB dos Municípios - base de dados 2010-2021.xlsx") |>
  readxl::read_excel(col_types = "text") |>
  janitor::clean_names() |>
  dplyr::select(
    ano, 
    codigo_do_municipio, 
    produto_interno_bruto_per_capita_a_precos_correntes_r_1_00
  ) |>
  dplyr::rename(
    year = ano,
    municipality_code = codigo_do_municipio,
    gdp_per_capita = 
      produto_interno_bruto_per_capita_a_precos_correntes_r_1_00,
  ) |>
  dplyr::mutate(
    year = as.integer(year),
    municipality_code = 
      municipality_code |>
      stringr::str_sub(end = -2) |>
      as.integer(),
    gdp_per_capita = as.numeric(gdp_per_capita)
  )
```

Source: IBGE-SIDRA [Table 5938](https://sidra.ibge.gov.br/tabela/5938) – Gross domestic product at current prices, taxes net of subsidies on products at current prices, and gross value added at current prices, total and by economic activity, and their respective shares - **Reference year 2010** [@ibgen].

```{r}
#| include: false

file_path <- here::here("data", "ibge-table-5938.rds")

if (prettycheck:::test_file_exists(file_path)) {
  ibge_table_5938 <- readRDS(file_path)
} else {
  cli::cli_abort("Data file not found.")
}
```

```{r}
#| eval: false
#| output: false

tictoc::tic()

ibge_table_5938 <- 
  get_and_aggregate_sidra_by_year(
    years = nutrition_data$year |> unique(),
    api_start = "/t/5938/n6/all/v/37/p/",
    api_end = "/d/v37%200"
  ) |>
  regularize_col_names()

tictoc::toc()

beepr::beep(1)
Sys.sleep(3)
```

```{r}
#| eval: false
#| output: false

# Last download: 2025-01-22 (~6m1s)

ibge_table_5938 |> 
  saveRDS(here::here("data", "ibge-table-5938.rds"))

ibge_table_5938 |> 
  readr::write_csv(here::here("data", "ibge-table-5938.csv"))
```

Source: IBGE-SIDRA [Table 6579](https://sidra.ibge.gov.br/tabela/6579) – Estimated resident population [@ibgel].

```{r}
#| include: false

file_path <- here::here("data", "ibge-table-6579.rds")

if (prettycheck:::test_file_exists(file_path)) {
  ibge_table_6579 <- readRDS(file_path)
} else {
  cli::cli_abort("Data file not found.")
}
```

```{r}
#| eval: false
#| output: false

tictoc::tic()

ibge_table_6579 <- 
  get_and_aggregate_sidra_by_year(
    years = nutrition_data$year |> unique(),
    api_start = "/t/6579/n6/all/v/all/p/",
    api_end = ""
  ) |>
  regularize_col_names()

tictoc::toc()

beepr::beep(1)
Sys.sleep(3)
```

```{r}
#| eval: false
#| output: false

# Last download: 2025-01-22 (~4m42s)

ibge_table_6579 |> 
  saveRDS(here::here("data", "ibge-table-6579.rds"))

ibge_table_6579 |> 
  readr::write_csv(here::here("data", "ibge-table-6579.csv"))
```

```{r}
gdp_data <- 
  ibge_table_5938 |>
  dplyr::left_join(
    ibge_table_6579,
    by = c("year", "municipality_code")
  ) |>
  dplyr::select(year, municipality_code, municipality.x, value.x, value.y) |>
  dplyr::rename(
    gdp = value.x,
    population = value.y,
    municipality = municipality.x
  ) |>
  dplyr::mutate(
    gdp = gdp * 1000,
    gdp_per_capita = gdp / population,
    year = as.integer(year),
    municipality_code = 
      municipality_code |>
      stringr::str_sub(end = -2) |>
      as.integer()
  )
```

### SPEI Data

```{r}
#| output: false

spei_data <- 
  here::here("data", "spei_Extreme_drought_event_municipality_year2.csv") |>
  readr::read_csv(col_types = readr::cols(.default = "c")) |>
  janitor::clean_names() |>
  dplyr::rename(municipality_code = code_muni) |>
  dplyr::select(
    municipality_code, 
    dplyr::all_of(paste0("spei_12m_", nutrition_data$year |> unique()))
  ) |>
  dplyr::mutate(
    dplyr::across(
      .cols = dplyr::starts_with("spei_12m"),
      .fns = as.numeric
    )
  ) |>
  tidyr::pivot_longer(
    cols = starts_with("spei_12m"),
    names_to = "year",
    values_to = "spei_12m"
  ) |>
  dplyr::mutate(
    municipality_code = 
      municipality_code |>
      substr(1, nchar(as.character(municipality_code)) - 1) |>
      as.integer(),
    year = 
      stringr::str_remove(year, "spei_12m_") |>
      as.integer()
  )
```

### Analysis Data

```{r}
#| output: false

data <- 
  nutrition_data |>
  dplyr::left_join(
    y = gdp_data,
    by = c("year", "municipality_code")
  ) |>
  dplyr::left_join(
    spei_data,
    by = c("year", "municipality_code")
  ) |>
  dplyr::select(
    year, municipality_code, misf, number_of_children, sisvan_cover, 
    mbepr, beipr, mbepr_beipr, maper, mpepr, maper_mpepr,
    gdp_per_capita, spei_12m
  ) |>
  tidyr::drop_na(sisvan_cover)
```

```{r}
#| output: false

dplyr::tibble(
  n = data |> nrow(),
  n_sisvan_cover_less_than_0_05 = 
    data |> 
    dplyr::filter(sisvan_cover < 0.05) |> 
    nrow(),
  n_sisvan_cover_more_than_1 =
    data |> 
    dplyr::filter(sisvan_cover > 1) |> 
    nrow(),
  n_brazil_municipalities =
    geobr::read_municipality(year = 2022, showProgress = FALSE) |> 
    dplyr::pull(code_muni) |> 
    length() |>
    rutils::shush(),
  missing_municipalities = 
    geobr::read_municipality(year = 2022, showProgress = FALSE) |> 
    dplyr::pull(code_muni) |> 
    stringr::str_sub(end = -2) |>
    as.integer() |>
    setdiff(data |> dplyr::pull(municipality_code)) |>
    length() |>
    rutils::shush()
) |>
  tidyr::pivot_longer(cols = dplyr::everything())
```

Adjusting the data to allow only muncipalities with a minimum of $5\%$ cover from SISVAN.

```{r}
#| output: false

data <- 
  data |>
  dplyr::filter(sisvan_cover >= 0.05)

data
```

```{r}
#| code-fold: false

data |>
  dplyr::pull(spei_12m) %>%
  min(na.rm = TRUE)
```

```{r}
#| code-fold: false

data |>
  dplyr::pull(spei_12m) %>%
  max(na.rm = TRUE)
```

#### Dictionary

- `year`: Year of data collection
- `municipality_code`: Brazilian Institute of Geography and Statistics (IBGE) municipality code
- `misf`: Cluster of the Revised Multidimensional Index for Sustainable Food Systems (MISFS-R) (A, B, C, or D)
- `number_of_children`: Number of children under five years old in the municipality
- `sisvan_cover`: Relative coverage of the Brazilian Food and Nutrition Surveillance System (SISVAN) in the municipality
- `mbepr`: Relative frequency of children under five years old with Very Short Stature for Age (*Muito Baixa Estatura Para a Idade*) in the municipality
- `beipr`: Relative frequency of children under five years old with Short Stature for Age (*Baixa Estatura Para Idade*) in the municipality
- `mbepr_beipr`: Relative frequency of children under five years old with Very Short/Short Stature for Age (*Muito Baixa/Baixa Estatura Para Idade*) in the municipality
- `maper`: Relative frequency of children under five years old with Severe Thinness for Height (*Magreza Acentuada Para a Estatura*) in the municipality
- `mpepr`: Relative frequency of children under five years old with Thinness for Height (*Magreza Por Estatura*) in the municipality
- `maper_mpepr`: Relative frequency of children under five years old with Severe/Moderate Thinness for Height (*Magreza Acentuada/Moderada Para a Estatura*) in the municipality
- `gdp_per_capita`: Gross Domestic Product (GDP) per capita in the municipality in Brazilian Reais (BRL)
- `spei_12m`: Standardised Precipitation Evapotranspiration Index (SPEI) in a 12-month times cale for the municipality

## Modeling the Data

### By `s(spei_12m) + gdp_per_capita + s(year, bs = "re")`

#### MBEPR – Very Short Stature for Age (*Muito Baixa Estatura Para a Idade*)

```{r}
mbepr_model_gamm <- mgcv::gam(
  mbepr ~ s(spei_12m) + gdp_per_capita + s(year, bs = "re"), 
  data = data,
  family = mgcv::betar(link = "logit")
)
```

```{r}
#| code-fold: false

mbepr_model_gamm |> summary()
```

```{r}
mbepr_model_gamm |> summarise_r2(nrow(data))
```

```{r}
mbepr_model_gamm |> 
  broom::glance() |> 
  tidyr::pivot_longer(dplyr::everything())
```

```{r}
mbepr_model_gamm |> broom::tidy()
```

```{r}
mbepr_model_gamm |> summarise_coefs()
```

```{r}
mbepr_model_gamm |> plot(pages = 1)
```

```{r}
mbepr_model_gamm |> mgcv::gam.check()
```

```{r}
data |>
plot_gamm(
  model = mbepr_model_gamm,
  title = paste0(
    "Very Short Stature for Age versus (MBEPR) versus \n", 
    "Standardised Precipitation Evapotranspiration Index (12 months)"
  ),
  y_label = "Predicted probability of MBEPR"
)
```

#### BEIPR – Short Stature for Age (*Baixa Estatura Para Idade*)

```{r}
beipr_model_gamm <- mgcv::gam(
  beipr ~ s(spei_12m) + gdp_per_capita + s(year, bs = "re"),
  data = data,
  family = mgcv::betar(link = "logit")
)
```

```{r}
#| code-fold: false

beipr_model_gamm |> summary()
```

```{r}
beipr_model_gamm |> summarise_r2(nrow(data))
```

```{r}
beipr_model_gamm |> 
  broom::glance() |> 
  tidyr::pivot_longer(dplyr::everything())
```

```{r}
beipr_model_gamm |> broom::tidy()
```

```{r}
beipr_model_gamm |> summarise_coefs()
```

```{r}
beipr_model_gamm |> plot(pages = 1)
```

```{r}
beipr_model_gamm |> mgcv::gam.check()
```

```{r}
data |>
plot_gamm(
  model = beipr_model_gamm,
  title = paste0(
    "Short Stature for Age (BEIPR) versus \n",
    "Standardised Precipitation Evapotranspiration Index (12 months)"
  ),
  y_label = "Predicted probability of BEIPR"
)
```

#### MBEPR & BEIPR – Very Short/Short Stature for Age (*Muito Baixa/Baixa Estatura Para Idade*)

```{r}
mbepr_beipr_model_gamm <- mgcv::gam(
  mbepr_beipr ~ s(spei_12m) + gdp_per_capita + s(year, bs = "re"),
  data = data,
  family = mgcv::betar(link = "logit")
)
```

```{r}
#| code-fold: false

mbepr_beipr_model_gamm |> summary()
```

```{r}
mbepr_beipr_model_gamm |> summarise_r2(nrow(data))
```

```{r}
mbepr_beipr_model_gamm |> 
  broom::glance() |> 
  tidyr::pivot_longer(dplyr::everything())
```

```{r}
mbepr_beipr_model_gamm |> broom::tidy()
```

```{r}
mbepr_beipr_model_gamm |> summarise_coefs()
```

```{r}
mbepr_beipr_model_gamm |> plot(pages = 1)
```

```{r}
mbepr_beipr_model_gamm |> mgcv::gam.check()
```

```{r}
data |>
plot_gamm(
  model = mbepr_beipr_model_gamm,
  title = paste0(
    "Very Short/Short Stature for Age (MBEPR & BEIPR) versus \n",
    "Standardised Precipitation Evapotranspiration Index (12 months)"
  ),
  y_label = "Predicted probability of MBEPR & BEIPR"
)
```

#### MAPER – Severe Thinness for Height (*Magreza Acentuada Para a Estatura*)

```{r}
maper_model_gamm <- mgcv::gam(
  maper ~ s(spei_12m) + gdp_per_capita + s(year, bs = "re"),
  data = data,
  family = mgcv::betar(link = "logit")
)
```

```{r}
#| code-fold: false

maper_model_gamm |> summary()
```

```{r}
maper_model_gamm |> summarise_r2(nrow(data))
```

```{r}
maper_model_gamm |> 
  broom::glance() |> 
  tidyr::pivot_longer(dplyr::everything())
```

```{r}
maper_model_gamm |> broom::tidy()
```

```{r}
maper_model_gamm |> summarise_coefs()
```

```{r}
maper_model_gamm |> plot(pages = 1)
```

```{r}
maper_model_gamm |> mgcv::gam.check()
```

```{r}
data |>
plot_gamm(
  model = maper_model_gamm,
  title = paste0(
    "Severe Thinness for Height (MAPER) versus \n",
    "Standardised Precipitation Evapotranspiration Index (12 months)"
  ),
  y_label = "Predicted probability of MAPER"
)
```

#### MPEPR – Thinness for Height (*Magreza Por Estatura*)

```{r}
mpepr_model_gamm <- mgcv::gam(
  mpepr ~ s(spei_12m) + gdp_per_capita + s(year, bs = "re"),
  data = data,
  family = mgcv::betar(link = "logit")
)
```

```{r}
#| code-fold: false

mpepr_model_gamm |> summary()
```

```{r}
mpepr_model_gamm |> summarise_r2(nrow(data))
```

```{r}
mpepr_model_gamm |> 
  broom::glance() |> 
  tidyr::pivot_longer(dplyr::everything())
```

```{r}
mpepr_model_gamm |> broom::tidy()
```

```{r}
mpepr_model_gamm |> summarise_coefs()
```

```{r}
mpepr_model_gamm |> plot(pages = 1)
```

```{r}
mpepr_model_gamm |> mgcv::gam.check()
```

```{r}
data |>
plot_gamm(
  model = mpepr_model_gamm,
  title = paste0(
    "Thinness for Height (MPEPR) versus \n",
    "Standardised Precipitation Evapotranspiration Index (12 months)"
  ),
  y_label = "Predicted probability of MPEPR"
)
```

#### MAPER & MPEPR – Severe/Moderate Thinness for Height (*Magreza Acentuada/Moderada Para a Estatura*)

```{r}
maper_mpepr_model_gamm <- mgcv::gam(
  maper_mpepr ~ s(spei_12m) + gdp_per_capita + s(year, bs = "re"),
  data = data,
  family = mgcv::betar(link = "logit")
)
```

```{r}
#| code-fold: false

maper_mpepr_model_gamm |> summary()
```

```{r}
maper_mpepr_model_gamm |> summarise_r2(nrow(data))
```

```{r}
maper_mpepr_model_gamm |> 
  broom::glance() |> 
  tidyr::pivot_longer(dplyr::everything())
```

```{r}
maper_mpepr_model_gamm |> broom::tidy()
```

```{r}
maper_mpepr_model_gamm |> summarise_coefs()
```

```{r}
maper_mpepr_model_gamm |> plot(pages = 1)
```

```{r}
maper_mpepr_model_gamm |> mgcv::gam.check()
```

```{r}
data |>
plot_gamm(
  model = maper_mpepr_model_gamm,
  title = paste0(
    "Severe/Moderate Thinness for Height (MAPER & MPEPR) versus \n",
    "Standardised Precipitation Evapotranspiration Index (12 months)"
  ),
  y_label = "Predicted probability of MAPER & MPEPR"
)
```

## Analyzing Model Results by MISFS-R Clusters

### By `s(spei_12m) + gdp_per_capita + s(year, bs = "re")`

::: {.callout-warning}
The charts of this session have fixed the values of `gdp_per_capita` and `year` at their respective means while predicting outcomes using the GAM model.
:::

#### MBEPR – Very Short Stature for Age (*Muito Baixa Estatura Para a Idade*)

```{r}
mbepr_model_gamm_misfs_1 <- 
  data |> 
  model_gamm_misfs(
    model = mbepr_model_gamm,
    type = 1
  )
```

```{r paged.print=FALSE}
#| code-fold: false

data |> summarise_model_gamm_misfs(mbepr_model_gamm_misfs_1)
```

```{r}
mbepr_model_gamm_misfs_1 |> summarise_coefs_misfs()
```

```{r}
data |>
  plot_gamm_misfs(
    gamm_models = mbepr_model_gamm_misfs_1,
    title = "Very Short Stature for Age (MBEPR) by MISFS",
    y_label = "Predicted probability of MBEPR",
    type = 1
  )
```

#### BEIPR – Short Stature for Age (*Baixa Estatura Para Idade*)

```{r}
beipr_model_gamm_misfs_1 <- 
  data |> 
  model_gamm_misfs(
    model = beipr_model_gamm,
    type = 1
  )
```

```{r paged.print=FALSE}
#| code-fold: false

data |> summarise_model_gamm_misfs(beipr_model_gamm_misfs_1)
```

```{r}
beipr_model_gamm_misfs_1 |> summarise_coefs_misfs()
```

```{r}
data |>
  plot_gamm_misfs(
    gamm_models = beipr_model_gamm_misfs_1,
    title = "Short Stature for Age (BEIPR) by MISFS",
    y_label = "Predicted probability of BEIPR",
    type = 1
  )
```

#### MAPER – Severe Thinness for Height (*Magreza Acentuada Para a Estatura*)

```{r}
maper_model_gamm_misfs_1 <- 
  data |> 
  model_gamm_misfs(
    model = maper_model_gamm,
    type = 1
  )
```

```{r paged.print=FALSE}
#| code-fold: false

data |> summarise_model_gamm_misfs(maper_model_gamm_misfs_1)
```

```{r}
maper_model_gamm_misfs_1 |> summarise_coefs_misfs()
```

```{r}
data |>
  plot_gamm_misfs(
    gamm_models = maper_model_gamm_misfs_1,
    title = "Severe Thinness for Height (MAPER) by MISFS",
    y_label = "Predicted probability of MAPER",
    type = 1
  )
```

#### MPEPR – Thinness for Height (*Magreza Por Estatura*)

```{r}
mpepr_model_gamm_misfs_1 <- 
  data |> 
  model_gamm_misfs(
    model = mpepr_model_gamm,
    type = 1
  )
```

```{r paged.print=FALSE}
#| code-fold: false

data |> summarise_model_gamm_misfs(mpepr_model_gamm_misfs_1)
```

```{r}
mpepr_model_gamm_misfs_1 |> summarise_coefs_misfs()
```

```{r}
data |>
  plot_gamm_misfs(
    gamm_models = mpepr_model_gamm_misfs_1,
    title = "Thinness for Height (MPEPR) by MISFS",
    y_label = "Predicted probability of MPEPR",
    type = 1
  )
```

### By `s(tear)`

#### MBEPR – Very Short Stature for Age (*Muito Baixa Estatura Para a Idade*)

```{r}
mbepr_model_gamm_misfs_2 <- 
  data |> 
  model_gamm_misfs(
    model = mbepr_model_gamm,
    type = 2
  )
```

```{r paged.print=FALSE}
#| code-fold: false

data |> summarise_model_gamm_misfs(mbepr_model_gamm_misfs_2)
```

```{r}
mbepr_model_gamm_misfs_2 |> summarise_coefs_misfs()
```

```{r}
data |>
  plot_gamm_misfs(
    gamm_models = mbepr_model_gamm_misfs_2,
    title = "Very Short Stature for Age (MBEPR) by MISFS",
    x_label = "Years",
    y_label = "Predicted probability of MBEPR",
    type = 2
  )
```

#### BEIPR – Short Stature for Age (*Baixa Estatura Para Idade*)

```{r}
beipr_model_gamm_misfs_2 <- 
  data |> 
  model_gamm_misfs(
    model = beipr_model_gamm,
    type = 2
  )
```

```{r paged.print=FALSE}
#| code-fold: false

data |> summarise_model_gamm_misfs(beipr_model_gamm_misfs_2)
```

```{r}
beipr_model_gamm_misfs_2 |> summarise_coefs_misfs()
```

```{r}
data |>
  plot_gamm_misfs(
    gamm_models = beipr_model_gamm_misfs_2,
    title = "Short Stature for Age (BEIPR) by MISFS",
    x_label = "Years",
    y_label = "Predicted probability of BEIPR",
    type = 2
  )
```

#### MAPER – Severe Thinness for Height (*Magreza Acentuada Para a Estatura*)

```{r}
maper_model_gamm_misfs_2 <- 
  data |> 
  model_gamm_misfs(
    model = maper_model_gamm,
    type = 2
  )
```

```{r paged.print=FALSE}
#| code-fold: false

data |> summarise_model_gamm_misfs(maper_model_gamm_misfs_2)
```

```{r}
maper_model_gamm_misfs_2 |> summarise_coefs_misfs()
```

```{r}
data |>
  plot_gamm_misfs(
    gamm_models = maper_model_gamm_misfs_2,
    title = "Severe Thinness for Height (MAPER) by MISFS",
    x_label = "Years",
    y_label = "Predicted probability of MAPER",
    type = 2
  )
```

#### MPEPR – Thinness for Height (*Magreza Por Estatura*)

```{r}
mpepr_model_gamm_misfs_2 <- 
  data |> 
  model_gamm_misfs(
    model = mpepr_model_gamm,
    type = 2
  )
```

```{r paged.print=FALSE}
#| code-fold: false

data |> summarise_model_gamm_misfs(mpepr_model_gamm_misfs_2)
```

```{r}
mpepr_model_gamm_misfs_2 |> summarise_coefs_misfs()
```

```{r}
data |>
  plot_gamm_misfs(
    gamm_models = mpepr_model_gamm_misfs_2,
    title = "Thinness for Height (MPEPR) by MISFS",
    x_label = "Years",
    y_label = "Predicted probability of MPEPR",
    type = 2
  )
```

## Acknowledgments

![](images/sustentarea-icon-rgb-150-dpi.png){style="width: 17.5%;"}

This analysis is part of the [Sustentarea](https://www.fsp.usp.br/sustentarea) Research and Extension Group's project: *Global syndemic: the impact of anthropogenic climate change on the health and nutrition of children under five years old attended by Brazil's public health system (SUS)*.

![](images/cnpq-logo.png){style="width: 30%;"}

This research was supported by the Conselho Nacional de Desenvolvimento Científico e Tecnológico - Brazil ([CNPq](https://www.gov.br/cnpq/)).

## How to Cite

To cite this work, please use the following format:

Magalhães, A. R., Vartanian, D, & Carvalho, A. M. (2025). *Global syndemic project data analysis: Report 3: Exploring the association between childhood undernutrition and the Standardized Precipitation Evapotranspiration Index (SPEI) in Brazilian municipalities (2008–2019)*. Sustentarea Research and Extension Group at the University of São Paulo. https://sustentarea.github.io/gs-data-analysis-report-3

A BibTeX entry for LaTeX users is

```         
@techreport{magalhaes2025,
  title = {Global syndemic project data analysis: Report 3: Exploring the association between childhood undernutrition and the Standardized Precipitation Evapotranspiration Index (SPEI) in Brazilian municipalities (2008–2019)},
  author = {{Arthur Ramalho Magalhães} and {Daniel Vartanian} and {Aline Martins de Carvalho}},
  year = {2025},
  address = {São Paulo},
  institution = {Sustentarea Research and Extension Group at the University of São Paulo},
  langid = {en},
  url = {https://sustentarea.github.io/gs-data-analysis-report-3}
}
```

## References {.unnumbered}

::: {#refs}
:::
