```{r}
#| label: setup
#| include: false

source(here::here("R", "_setup.R"))
```

## Overview

This document explore possible associations between undertrition in children with the Standardised Precipitation Evapotranspiration Index (SPEI) of municipalities in Brazil during 2008-2019 period. It is part of the [Sustentarea](https://www.fsp.usp.br/sustentarea) Research and Extension Group's project titled *Global Syndemic: The Impact of Anthropogenic Climate Change on the Health and Nutrition of Children Under Five Years Old Served by Brazil's Public Health System (SUS)*.

::: {.callout-warning}
Please note that this is a preliminary report intended to support decision-making and may not include all the details of the analysis.
:::

## Methods

### Approach and procedure method

The analysis will rely solely on a visual inspection of the data. If necessary, additional analysis and updates will be incorporated into this report later.

### Source of data/information

The data used in this analysis have as sources:

- The Brazilian Institute of Geography and Statistics ([IBGE](https://www.ibge.gov.br/)) Automatic Retrieval System ([SIDRA](https://sidra.ibge.gov.br/)), for data on GDP per capita.
- Brazil's Food and Nutrition Surveillance System (SISVAN) ([link to SISVAN](https://sisaps.saude.gov.br/sisvan/), for data on malnutrition.
- [WorldClim](https://worldclim.org/data/index.html), for data on bioclimatic variables, which allowed us to calculate the Standardised Precipitation Evapotranspiration Index (SPEI) for municipalities in Brazil.

### Data wrangling

The data wrangling and analysis followed the data science framework outlined by Hadley Wickham et al. [@wickham2023e], as illustrated in [@fig-wickham-at-al-2024-figure-1].

::: {#fig-wickham-at-al-2024-figure-1}
![](images/wickham-at-al-2024-figure-1.png){width=75%}

[Source: Reproduced from @wickham2023e.]{.legend}

Model of the data science process created by Wickham, Çetinkaya-Runde, and Grolemund [-@wickham2023e].
:::

All the analyses are 100% reproducible and can be run again at any time. See the [README](https://github.com/sustentarea/gs-data-analysis-report-2/blob/main/README.md) file on the code repository to learn how to run them.

## Setting the Enviroment

```{r}
#| eval: false

library(beepr)
library(cli)
library(dplyr)
library(ggplot2)
library(glmmTMB)
library(janitor)
library(lme4)
library(magrittr)
library(mgcv)
library(patchwork)
library(polyglotr)
library(prettycheck) # github.com/danielvartan/prettycheck
library(readxl)
library(stats)
library(stringr)
library(tidyr)
```

```{r}
#| include: false

library(magrittr)
library(mgcv)
library(ggplot2)
```

## Loading functions

```{r}
source(here::here("R", "coef_mean.R"))
source(here::here("R", "model_gamm_misfs.R"))
source(here::here("R", "plot_gamm.R"))
source(here::here("R", "utils.R"))
source(here::here("R", "utils-plots.R"))
```

## Importing and Tidying the Data

### GDP Data

```{r}
gdp_data <- 
  here::here("data", "PIB dos Municípios - base de dados 2010-2021.xlsx") |>
  readxl::read_excel(col_types = "text") |>
  janitor::clean_names() |>
  dplyr::select(
    ano, 
    codigo_do_municipio, 
    produto_interno_bruto_per_capita_a_precos_correntes_r_1_00
  ) |>
  dplyr::rename(
    year = ano,
    municipality_code = codigo_do_municipio,
    gdp_per_capita = 
      produto_interno_bruto_per_capita_a_precos_correntes_r_1_00,
  ) |>
  dplyr::mutate(
    year = as.integer(year),
    municipality_code = 
      municipality_code |>
      stringr::str_sub(end = -2) |>
      as.integer(),
    gdp_per_capita = as.numeric(gdp_per_capita)
  )

gdp_data
```

### Nutrition Data

```{r}
nutrition_data <-
  here::here("data", "Banco_dados_malnutritio_clima - Adaptado.csv") |>
  readr::read_csv(col_types = readr::cols(.default = "c")) |>
  dplyr::mutate(
    dplyr::across(
      .cols = dplyr::everything(),
      .fns = ~ 
        iconv(.x, from = "UTF-8", to = "iso-8859-1") |>
        readr::parse_guess()
    )
  ) |>
  janitor::clean_names() |>
  dplyr::rename(
    year = ano,
    municipality_code = code_muni
  ) |>
  dplyr::mutate(
    year = as.integer(year),
    municipality_code = as.integer(municipality_code),
    cobrs = as.numeric(cobrs)
  )

nutrition_data
```

### SPEI Data

```{r}
spei_data <- 
  here::here("data", "spei_Extreme_drought_event_municipality_year2.csv") |>
  readr::read_csv(col_types = readr::cols(.default = "c")) |>
  janitor::clean_names() |>
  dplyr::rename(
    municipality_code = code_muni,
    municipality_name = name_muni
  ) |>
  dplyr::select(
    municipality_code, 
    dplyr::starts_with("spei_12m_20")
  ) |>
  dplyr::mutate(
    dplyr::across(
      .cols = dplyr::starts_with("spei_12m_20"),
      .fns = as.numeric
    )
  ) |>
  tidyr::pivot_longer(
    cols = starts_with("spei_12m_20"),
    names_to = "year",
    values_to = "spei_12m"
  ) |>
  dplyr::mutate(
    municipality_code = 
      municipality_code |>
      substr(1, nchar(as.character(municipality_code)) - 1) |>
      as.integer(),
    year = 
      gsub("spei_12m_", "", year) |>
      as.integer(),
  )
  
spei_data
```

### Analysis Data

```{r}
data <- 
  gdp_data |>
  dplyr::full_join(
    y = nutrition_data,
    by = c("year", "municipality_code")
  ) |>
  dplyr::left_join(
    spei_data,
    by = c("year", "municipality_code")
  )

data
```

## Checking for Muncipalities With Minimum 5% Cover from SISVAN

```{r}
#| code-fold: false

data |>
  dplyr::pull(cobrs) %>%
  sum(. < 0.05, na.rm = TRUE)
```

```{r}
#| code-fold: false

data |>
  dplyr::pull(cobrs) %>%
  sum(. > 1, na.rm = TRUE)
```

```{r}
#| code-fold: false

data <- 
  data |>
  dplyr::filter(cobrs >= 0.05)

data
```

```{r}
#| code-fold: false

min(data$spei_12m)
```

```{r}
#| code-fold: false

max(data$spei_12m)
```

## Generalized Linear Mixed Model (GLMM)

### MBEPR – Very Short Stature for Age (Muito Baixa Estatura Para a Idade)

::: {.callout-caution}
See 
<https://cran.r-project.org/web/packages/glmmTMB/vignettes/troubleshooting.html>
to learn more about the model warnings.
:::

```{r}
#| code-fold: false

mbepr_model <- glmmTMB::glmmTMB(
  mbepr ~ spei_12m + gdp_per_capita + (1 | year),
  data = data,
  family = glmmTMB::betabinomial(link = "logit"),
  control = glmmTMB::glmmTMBControl(
    optimizer = optim, 
    optArgs = list(method = "BFGS")
  )
)

mbepr_model
```

```{r}
overdispersion_test <- 
  mbepr_model |>
  stats::residuals(type = "pearson") %>%
  `^`(2) %>%
  `/`(mbepr_model$df.residual) |>
  sum()
```

```{r}
#| code-fold: false

cli::cli_inform("Overdispersion statistic: {overdispersion_test}\n")

if (overdispersion_test > 1.5) {
  cli::cli_inform("There might still be overdispersion in the model.\n")
}
```

```{r}
dplyr::tibble(
  fitted = stats::fitted(mbepr_model),
  residuals = stats::residuals(mbepr_model, type = "pearson")
) |>
  ggplot2::ggplot(ggplot2::aes(x = fitted, y = residuals)) +
  ggplot2::geom_point(alpha = 0.5) +
  ggplot2::geom_hline(
    yintercept = 0, 
    color = get_brand_color("red")
  ) +
  ggplot2::labs(
    x = "Fitted values",
    y = "Pearson residuals",
    title = "Residuals vs. Fitted"
  )
```

```{r}
data |>
  ggplot2::ggplot(ggplot2::aes(x = spei_12m, y = mbepr)) +
  ggplot2::geom_point(alpha = 0.5) +
  ggplot2::geom_smooth(
    method = "glm", 
    method.args = list(family = "binomial"), 
    se = TRUE, 
    color = get_brand_color("red")
  ) +
  ggplot2::labs(
    x = "SPEI (12 months)",
    y = "Probability of MBEPR",
    title = "Relationship between SPEI_12m and MBEPR"
  )
```

```{r}
data |>
  tidyr::drop_na(gdp_per_capita, mbepr) |>
  ggplot2::ggplot(ggplot2::aes(x = gdp_per_capita, y = mbepr)) +
  ggplot2::geom_point(alpha = 0.5) +
  ggplot2::geom_smooth(
    method = "glm", 
    method.args = list(family = "binomial"), 
    se = TRUE, 
    color = get_brand_color("red")
  ) +
  ggplot2::labs(
    x = "GDP per capita",
    y = "Very Short Stature for Age (MBEPR)",
    title = "Relationship between GDP per capita and MBEPR"
  )
``` 

### BEIPR – Short Stature for Age (Baixa Estatura Para Idade)

```{r}
#| code-fold: false

beipr_model <- glmmTMB::glmmTMB(
  beipr ~ spei_12m * gdp_per_capita + (1 | year),
  data = data,
  family = glmmTMB::betabinomial(link = "logit")
)

beipr_model
```

```{r}
#| code-fold: false

summary(beipr_model)
```

### MAPER – Severe Thinness for Height (Magreza Acentuada Para a Estatura)

```{r}
#| code-fold: false

maper_model <- glm(
  maper ~ spei_12m * gdp_per_capita,
  data = data,
  family = quasibinomial(link = "logit")
)

maper_model
```

```{r}
#| code-fold: false

summary(maper_model)
```

### MPEPR – Thinness for Height (Magreza Por Estatura)

```{r}
#| code-fold: false

mpepr_model <- glm(
  mpepr ~ spei_12m * gdp_per_capita,
  data = data,
  family = quasibinomial(link = "logit")
)

mpepr_model
```

```{r}
#| code-fold: false

summary(mpepr_model)
```

## Generalized Additive Model Mixed Effects (GAMM)

### MBEPR – Very Short Stature for Age (Muito Baixa Estatura Para a Idade)

```{r}
data <-
  data |>
  dplyr::mutate(
    mbepr = pmax(0.0001, pmin(0.9999, mbepr))
  )
```

```{r}
mbepr_model_gamm <- mgcv::gam(
  mbepr ~ s(spei_12m) + gdp_per_capita + s(year, bs = "re"), 
  data = data,
  family = mgcv::betar(link = "logit")
)

mbepr_model_gamm
```

```{r}
#| code-fold: false

summary(mbepr_model_gamm)
```

```{r}
mbepr_model_gamm |> plot(pages = 1)
```

```{r}
#| code-fold: false

mbepr_model_gamm |> coef_mean()
```

```{r}
#| code-fold: false

mbepr_model_gamm |> coef_spei12m_mean()
```

```{r}
data |>
plot_gamm(
  model = mbepr_model_gamm,
  title = paste0(
    "Very Short Stature for Age versus (MBEPR) versus \n", 
    "Standardised Precipitation Evapotranspiration Index"
  ),
  y_label = "Predicted MBEPR"
)
```

### BEIPR – Short Stature for Age (Baixa Estatura Para Idade)

```{r}
data <-
  data |>
  dplyr::mutate(
    beipr = pmax(0.0001, pmin(0.9999, beipr))
  )
```

```{r}
beipr_model_gamm <- mgcv::gam(
  beipr ~ s(spei_12m) + gdp_per_capita + s(year, bs = "re"),
  data = data,
  family = mgcv::betar(link = "logit")
)

beipr_model_gamm
```

```{r}
#| code-fold: false

summary(beipr_model_gamm)
```

```{r}
beipr_model_gamm |> plot(pages = 1)
```

```{r}
#| code-fold: false

beipr_model_gamm |> coef_mean()
```

```{r}
#| code-fold: false

beipr_model_gamm |> coef_spei12m_mean()
```

```{r}
data |>
plot_gamm(
  model = beipr_model_gamm,
  title = paste0(
    "Short Stature for Age (BEIPR) versues \n",
    "Standardised Precipitation Evapotranspiration Index"
  ),
  x_label = "SPEI 12m",
  y_label = "Predicted BEIPR"
)
```

### MAPER – Severe Thinness for Height (Magreza Acentuada Para a Estatura)

```{r}
data <-
  data |>
  dplyr::mutate(
    maper = pmax(0.0001, pmin(0.9999, maper))
  )
```

```{r}
maper_model_gamm <- mgcv::gam(
  maper ~ s(spei_12m) + gdp_per_capita + s(year, bs = "re"),
  data = data,
  family = mgcv::betar(link = "logit")
)

maper_model_gamm
```

```{r}
#| code-fold: false

summary(maper_model_gamm)
```

```{r}
maper_model_gamm |> plot(pages = 1)
```

```{r}
#| code-fold: false

maper_model_gamm |> coef_mean()
```

```{r}
#| code-fold: false

maper_model_gamm |> coef_spei12m_mean()
```

```{r}
data |>
plot_gamm(
  model = maper_model_gamm,
  title = paste0(
    "Severe Thinness for Height (MAPER) versus \n",
    "Standardised Precipitation Evapotranspiration Index"
  ),
  y_label = "Predicted MAPER"
)
```

### MPEPR – Thinness for Height (Magreza Por Estatura)

```{r}
data <-
  data |>
  dplyr::mutate(
    mpepr = pmax(0.0001, pmin(0.9999, mpepr))
  )
```

```{r}
mpepr_model_gamm <- mgcv::gam(
  mpepr ~ s(spei_12m) + gdp_per_capita + s(year, bs = "re"),
  data = data,
  family = mgcv::betar(link = "logit")
)

mpepr_model_gamm
```

```{r}
#| code-fold: false

summary(mpepr_model_gamm)
```

```{r}
mpepr_model_gamm |> plot(pages = 1)
```

```{r}
#| code-fold: false

mpepr_model_gamm |> coef_mean()
```

```{r}
#| code-fold: false

mpepr_model_gamm |> coef_spei12m_mean()
```

```{r}
data |>
plot_gamm(
  model = mpepr_model_gamm,
  title = paste0(
    "Thinness for Height (MPEPR) versus \n",
    "Standardised Precipitation Evapotranspiration Index"
  ),
  y_label = "Predicted MPEPR"
)
```

### Model Check

```{r}
mgcv::gam.check(mbepr_model_gamm)
```

```{r}
mgcv::gam.check(beipr_model_gamm)
```

```{r}
mgcv::gam.check(maper_model_gamm)
```

```{r}
mgcv::gam.check(mpepr_model_gamm)
```

## Analysis by MISFS

### By S(SPEI 12m) + GDP Per Capita + S(Year)

#### MBEPR – Very Short Stature for Age (Muito Baixa Estatura Para a Idade)

```{r}
mbepr_model_gamm_misfs_1 <- 
  data |> 
  model_gamm_misfs(
    model = mbepr_model_gamm,
    type = 1
  )
```

```{r}
#| code-fold: false

mbepr_model_gamm_misfs_1 |> summarise_model_gamm_misfs()
```

```{r}
#| code-fold: false

mbepr_model_gamm_misfs_1 |> coef_means_misfs()
```

```{r}
#| code-fold: false

mbepr_model_gamm_misfs_1 |> coef_spei12m_means_misfs()
```

```{r}
data |>
  plot_gamm_misfs(
    gamm_models = mbepr_model_gamm_misfs_1,
    title = "Very Short Stature for Age (MBEPR) by MISFS",
    y_label = "Predicted MBEPR",
    type = 1
  )
```

#### BEIPR – Short Stature for Age (Baixa Estatura Para Idade)

```{r}
beipr_model_gamm_misfs_1 <- 
  data |> 
  model_gamm_misfs(
    model = beipr_model_gamm,
    type = 1
  )
```

```{r}
#| code-fold: false

beipr_model_gamm_misfs_1 |> summarise_model_gamm_misfs()
```

```{r}
#| code-fold: false

beipr_model_gamm_misfs_1 |> coef_means_misfs()
```

```{r}
#| code-fold: false

beipr_model_gamm_misfs_1 |> coef_spei12m_means_misfs()
```

```{r}
data |>
  plot_gamm_misfs(
    gamm_models = beipr_model_gamm_misfs_1,
    title = "Short Stature for Age (BEIPR) by MISFS",
    y_label = "Predicted BEIPR",
    type = 1
  )
```

#### MAPER – Severe Thinness for Height (Magreza Acentuada Para a Estatura)

```{r}
maper_model_gamm_misfs_1 <- 
  data |> 
  model_gamm_misfs(
    model = maper_model_gamm,
    type = 1
  )
```

```{r}
#| code-fold: false

maper_model_gamm_misfs_1 |> summarise_model_gamm_misfs()
```

```{r}
#| code-fold: false

maper_model_gamm_misfs_1 |> coef_means_misfs()
```

```{r}
#| code-fold: false

maper_model_gamm_misfs_1 |> coef_spei12m_means_misfs()
```

```{r}
data |>
  plot_gamm_misfs(
    gamm_models = maper_model_gamm_misfs_1,
    title = "Severe Thinness for Height (MAPER) by MISFS",
    y_label = "Predicted MAPER",
    type = 1
  )
```

#### MPEPR – Thinness for Height (Magreza Por Estatura)

```{r}
mpepr_model_gamm_misfs_1 <- 
  data |> 
  model_gamm_misfs(
    model = mpepr_model_gamm,
    type = 1
  )
```

```{r}
#| code-fold: false

mpepr_model_gamm_misfs_1 |> summarise_model_gamm_misfs()
```

```{r}
#| code-fold: false

mpepr_model_gamm_misfs_1 |> coef_means_misfs()
```

```{r}
#| code-fold: false

mpepr_model_gamm_misfs_1 |> coef_spei12m_means_misfs()
```

```{r}
data |>
  plot_gamm_misfs(
    gamm_models = mpepr_model_gamm_misfs_1,
    title = "Thinness for Height (MPEPR) by MISFS",
    y_label = "Predicted MPEPR",
    type = 1
  )
```

### Only by S(Year)

#### MBEPR – Very Short Stature for Age (Muito Baixa Estatura Para a Idade)

```{r}
mbepr_model_gamm_misfs_2 <- 
  data |> 
  model_gamm_misfs(
    model = mbepr_model_gamm,
    type = 2
  )
```

```{r}
#| code-fold: false

mbepr_model_gamm_misfs_2 |> summarise_model_gamm_misfs()
```

```{r}
#| code-fold: false

mbepr_model_gamm_misfs_2 |> coef_means_misfs()
```

```{r}
summarise_model_gamm_misfs_2(mbepr_model_gamm_misfs_2)
```

```{r}
data |>
  plot_gamm_misfs(
    gamm_models = mbepr_model_gamm_misfs_2,
    title = "Very Short Stature for Age (MBEPR) by MISFS",
    x_label = "Years",
    y_label = "Predicted MBEPR",
    type = 2
  )
```

#### BEIPR – Short Stature for Age (Baixa Estatura Para Idade)

```{r}
beipr_model_gamm_misfs_2 <- 
  data |> 
  model_gamm_misfs(
    model = beipr_model_gamm,
    type = 2
  )
```

```{r}
#| code-fold: false

beipr_model_gamm_misfs_2 |> summarise_model_gamm_misfs()
```

```{r}
#| code-fold: false

beipr_model_gamm_misfs_2 |> coef_means_misfs()
```

```{r}
summarise_model_gamm_misfs_2(beipr_model_gamm_misfs_2)
```

```{r}
data |>
  plot_gamm_misfs(
    gamm_models = beipr_model_gamm_misfs_2,
    title = "Short Stature for Age (BEIPR) by MISFS",
    y_label = "Predicted BEIPR",
    type = 2
  )
```

#### MAPER – Severe Thinness for Height (Magreza Acentuada Para a Estatura)

```{r}
maper_model_gamm_misfs_2 <- 
  data |> 
  model_gamm_misfs(
    model = maper_model_gamm,
    type = 2
  )
```

```{r}
#| code-fold: false

maper_model_gamm_misfs_2 |> summarise_model_gamm_misfs()
```

```{r}
#| code-fold: false

maper_model_gamm_misfs_2 |> coef_means_misfs()
```

```{r}
summarise_model_gamm_misfs_2(maper_model_gamm_misfs_2)
```

```{r}
data |>
  plot_gamm_misfs(
    gamm_models = maper_model_gamm_misfs_2,
    title = "Severe Thinness for Height (MAPER) by MISFS",
    y_label = "Predicted MAPER",
    type = 2
  )
```

#### MPEPR – Thinness for Height (Magreza Por Estatura)

```{r}
mpepr_model_gamm_misfs_2 <- 
  data |> 
  model_gamm_misfs(
    model = mpepr_model_gamm,
    type = 2
  )
```

```{r}
#| code-fold: false

mpepr_model_gamm_misfs_2 |> summarise_model_gamm_misfs()
```

```{r}
#| code-fold: false

mpepr_model_gamm_misfs_2 |> coef_means_misfs()
```

```{r}
summarise_model_gamm_misfs_2(mpepr_model_gamm_misfs_2)
```

```{r}
data |>
  plot_gamm_misfs(
    gamm_models = mpepr_model_gamm_misfs_2,
    title = "Thinness for Height (MPEPR) by MISFS",
    y_label = "Predicted MPEPR",
    type = 2
  )
```

## Acknowledgments

![](images/sustentarea-icon-rgb-150-dpi.png){style="width: 17.5%;"}

This analysis is part of the [Sustentarea](https://www.fsp.usp.br/sustentarea) Research and Extension Group's project: *Global syndemic: the impact of anthropogenic climate change on the health and nutrition of children under five years old attended by Brazil's public health system (SUS)*.

![](images/cnpq-logo.png){style="width: 30%;"}

This research was supported by the Conselho Nacional de Desenvolvimento Científico e Tecnológico - Brazil ([CNPq](https://www.gov.br/cnpq/)).

## References {.unnumbered}

::: {#refs}
:::
