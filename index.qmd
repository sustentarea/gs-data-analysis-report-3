```{r}
#| label: setup
#| include: false

source(here::here("R", "_setup.R"))
```

## Overview

This report explores potential associations between childhood undernutrition and the Standardized Precipitation Evapotranspiration Index [SPEI](https://en.wikipedia.org/wiki/Standardised_Precipitation_Evapotranspiration_Index)) in Brazilian municipalities (2008–2019). It is part of the [Sustentarea](https://www.fsp.usp.br/sustentarea) Research and Extension Group's project titled *Global syndemic: The impact of anthropogenic climate change on the health and nutrition of children under five years old served by Brazil's public health system (SUS)*.

::: {.callout-warning}
Please note that this report is designed to support decision-making and may not include all the details of the analysis.
:::

## Methods

### Approach and Procedure Method

The analysis was conducted based solely on visual inspections of the data. If needed, further analyses and updates will be integrated into this report at a later stage.

### Source of Data/Information

The data used in this analysis have as sources:

- The Brazilian Institute of Geography and Statistics ([IBGE](https://www.ibge.gov.br/)) Automatic Retrieval System ([SIDRA](https://sidra.ibge.gov.br/)), for data on GDP per capita.
- Brazil's Food and Nutrition Surveillance System ([SISVAN](https://sisaps.saude.gov.br/sisvan/)), for data on malnutrition.
- [WorldClim](https://worldclim.org/data/index.html), for data on bioclimatic variables, which allowed us to calculate the Standardised Precipitation Evapotranspiration Index (SPEI) for municipalities in Brazil.

The data files can be found in the [data](https://github.com/sustentarea/gs-data-analysis-report-3/tree/main/data) directory of the code repository.

### Data Wrangling

The data wrangling and analysis followed the data science framework outlined by @wickham2023e, as illustrated in [@fig-wickham-at-al-2024-figure-1].

::: {#fig-wickham-at-al-2024-figure-1}
![](images/wickham-at-al-2024-figure-1.png){width=75%}

[Source: Reproduced from @wickham2023e.]{.legend}

Model of the data science process created by Wickham, Çetinkaya-Runde, and Grolemund.
:::

All the analyses are 100% reproducible and can be run again at any time. See the [README](https://github.com/sustentarea/gs-data-analysis-report-3/blob/main/README.md) file on the code repository to learn how to run them.

### Interpretation of Results

To ensure practical significance, the adjusted $\text{R}^2$ of the models are analysed for their effect sizes considering a confidence interval of $0.95$. We use @cohen1988a benchmark for interpretation.

A $\text{R}^2$ less than $\approx 0.0196$ is considered negligeble. Please note the following excerpts from @cohen1988a:

> SMALL EFFECT SIZE: $f^2 = .02$. Translated into $\text{R}^{2}$ or partial $\text{R}^{2}$ for Case 1, this gives $.02 / (1 + .02) = .0196$. We thus define a small effect as one that accounts for 2% of the $\text{Y}$ variance (in contrast with 1% for $r$), and translate to an $\text{R} = \sqrt{0196} = .14$ (compared to .10 for $r$). This is a modest enough amount, **just barely escaping triviality** and (alas!) all too frequently in practice represents the true order of magnitude of the effect being tested [@cohen1988a, p. 413].

> [...] in many circumstances, all that is intended by "proving" the null hypothesis is that the ES [Effect Size] is not necessarily zero but **small enough to be negligible** [...]. [@cohen1988a, p. 461].

## Setting the Enviroment

```{r}
#| eval: false

library(beepr)
library(cli)
library(dplyr)
library(effectsize)
library(ggplot2)
library(glmmTMB)
library(janitor)
library(lme4)
library(magrittr)
library(mgcv)
library(MuMIn)
library(patchwork)
library(performance)
library(polyglotr)
library(prettycheck) # github.com/danielvartan/prettycheck
library(psychometric)
library(r2glmm)
library(readxl)
library(rutils) # github.com/danielvartan/rutils
library(stats)
library(stringr)
library(tidyr)
```

```{r}
#| include: false

library(magrittr)
library(mgcv)
library(ggplot2)
```

```{r}
source(here::here("R", "coef_mean.R"))
source(here::here("R", "model_gamm_misfs.R"))
source(here::here("R", "plot_gamm.R"))
source(here::here("R", "utils.R"))
source(here::here("R", "utils-plots.R"))
```

## Importing and Tidying the Data

### GDP Per Capita Data

```{r}
#| output: false

gdp_data <- 
  here::here("data", "PIB dos Municípios - base de dados 2010-2021.xlsx") |>
  readxl::read_excel(col_types = "text") |>
  janitor::clean_names() |>
  dplyr::select(
    ano, 
    codigo_do_municipio, 
    produto_interno_bruto_per_capita_a_precos_correntes_r_1_00
  ) |>
  dplyr::rename(
    year = ano,
    municipality_code = codigo_do_municipio,
    gdp_per_capita = 
      produto_interno_bruto_per_capita_a_precos_correntes_r_1_00,
  ) |>
  dplyr::mutate(
    year = as.integer(year),
    municipality_code = 
      municipality_code |>
      stringr::str_sub(end = -2) |>
      as.integer(),
    gdp_per_capita = as.numeric(gdp_per_capita)
  )
```

### Nutrition Data

```{r}
#| output: false

nutrition_data <-
  here::here("data", "Banco_dados_malnutritio_clima - Adaptado.csv") |>
  readr::read_csv(col_types = readr::cols(.default = "c")) |>
  dplyr::mutate(
    dplyr::across(
      .cols = dplyr::everything(),
      .fns = ~ 
        iconv(.x, from = "UTF-8", to = "iso-8859-1") |>
        readr::parse_guess()
    )
  ) |>
  janitor::clean_names() |>
  dplyr::rename(
    year = ano,
    municipality_code = code_muni
  ) |>
  dplyr::mutate(
    year = as.integer(year),
    municipality_code = as.integer(municipality_code),
    cobrs = as.numeric(cobrs),
    mbepr = pmax(0.0001, pmin(0.9999, mbepr)),
    beipr = pmax(0.0001, pmin(0.9999, beipr)),
    maper = pmax(0.0001, pmin(0.9999, maper)),
    mpepr = pmax(0.0001, pmin(0.9999, mpepr))
  )
```

### SPEI Data

```{r}
#| output: false

spei_data <- 
  here::here("data", "spei_Extreme_drought_event_municipality_year2.csv") |>
  readr::read_csv(col_types = readr::cols(.default = "c")) |>
  janitor::clean_names() |>
  dplyr::rename(
    municipality_code = code_muni,
    municipality_name = name_muni
  ) |>
  dplyr::select(
    municipality_code, 
    dplyr::starts_with("spei_12m_20")
  ) |>
  dplyr::mutate(
    dplyr::across(
      .cols = dplyr::starts_with("spei_12m_20"),
      .fns = as.numeric
    )
  ) |>
  tidyr::pivot_longer(
    cols = starts_with("spei_12m_20"),
    names_to = "year",
    values_to = "spei_12m"
  ) |>
  dplyr::mutate(
    municipality_code = 
      municipality_code |>
      substr(1, nchar(as.character(municipality_code)) - 1) |>
      as.integer(),
    year = 
      gsub("spei_12m_", "", year) |>
      as.integer(),
  )
```

### Analysis Data

```{r}
#| output: false

data <- 
  gdp_data |>
  dplyr::full_join(
    y = nutrition_data,
    by = c("year", "municipality_code")
  ) |>
  dplyr::left_join(
    spei_data,
    by = c("year", "municipality_code")
  ) |>
  dplyr::select(
    year, municipality_code, misf, cobrs, mbepr, beipr, maper, 
    mpepr, gdp_per_capita, spei_12m
  )
```

Adjusting the data to allow only muncipalities with a minimum of $5\%$ cover from SISVAN.

```{r}
#| code-fold: false

data |>
  dplyr::pull(cobrs) %>%
  sum(. < 0.05, na.rm = TRUE)
```

```{r}
#| code-fold: false

data |>
  dplyr::pull(cobrs) %>%
  sum(. > 1, na.rm = TRUE)
```

```{r}
#| code-fold: false

data <- 
  data |>
  dplyr::filter(cobrs >= 0.05)

data
```

```{r}
#| code-fold: false

data |>
  dplyr::pull(spei_12m) %>%
  min(na.rm = TRUE)
```

```{r}
#| code-fold: false

data |>
  dplyr::pull(spei_12m) %>%
  max(na.rm = TRUE)
```

## Modeling the Data

For this analysis we used Generalized Additive Models ([GAMs](https://en.wikipedia.org/wiki/Generalized_additive_model)).

### MBEPR – Very Short Stature for Age (*Muito Baixa Estatura Para a Idade*)

```{r}
mbepr_model_gamm <- mgcv::gam(
  mbepr ~ s(spei_12m) + gdp_per_capita + s(year, bs = "re"), 
  data = data,
  family = mgcv::betar(link = "logit")
)
```

```{r}
#| code-fold: false

summary(mbepr_model_gamm)
```

```{r}
summarise_r2(mbepr_model_gamm, n = nrow(data))
```

```{r}
#| code-fold: false

mbepr_model_gamm |> coef_mean()
```

```{r}
#| code-fold: false

mbepr_model_gamm |> coef_spei12m_mean()
```

```{r}
mbepr_model_gamm |> plot(pages = 1)
```

```{r}
mgcv::gam.check(mbepr_model_gamm)
```

```{r}
data |>
plot_gamm(
  model = mbepr_model_gamm,
  title = paste0(
    "Very Short Stature for Age versus (MBEPR) versus \n", 
    "Standardised Precipitation Evapotranspiration Index"
  ),
  y_label = "Predicted MBEPR"
)
```

### BEIPR – Short Stature for Age (*Baixa Estatura Para Idade*)

```{r}
beipr_model_gamm <- mgcv::gam(
  beipr ~ s(spei_12m) + gdp_per_capita + s(year, bs = "re"),
  data = data,
  family = mgcv::betar(link = "logit")
)
```

```{r}
#| code-fold: false

summary(beipr_model_gamm)
```

```{r}
summarise_r2(beipr_model_gamm, n = nrow(data))
```

```{r}
#| code-fold: false

beipr_model_gamm |> coef_mean()
```

```{r}
#| code-fold: false

beipr_model_gamm |> coef_spei12m_mean()
```

```{r}
beipr_model_gamm |> plot(pages = 1)
```

```{r}
mgcv::gam.check(beipr_model_gamm)
```

```{r}
data |>
plot_gamm(
  model = beipr_model_gamm,
  title = paste0(
    "Short Stature for Age (BEIPR) versues \n",
    "Standardised Precipitation Evapotranspiration Index"
  ),
  x_label = "SPEI 12m",
  y_label = "Predicted BEIPR"
)
```

### MAPER – Severe Thinness for Height (*Magreza Acentuada Para a Estatura*)

```{r}
maper_model_gamm <- mgcv::gam(
  maper ~ s(spei_12m) + gdp_per_capita + s(year, bs = "re"),
  data = data,
  family = mgcv::betar(link = "logit")
)
```

```{r}
#| code-fold: false

summary(maper_model_gamm)
```

```{r}
summarise_r2(maper_model_gamm, n = nrow(data))
```

```{r}
#| code-fold: false

maper_model_gamm |> coef_mean()
```

```{r}
#| code-fold: false

maper_model_gamm |> coef_spei12m_mean()
```

```{r}
maper_model_gamm |> plot(pages = 1)
```

```{r}
mgcv::gam.check(maper_model_gamm)
```

```{r}
data |>
plot_gamm(
  model = maper_model_gamm,
  title = paste0(
    "Severe Thinness for Height (MAPER) versus \n",
    "Standardised Precipitation Evapotranspiration Index"
  ),
  y_label = "Predicted MAPER"
)
```

### MPEPR – Thinness for Height (*Magreza Por Estatura*)

```{r}
mpepr_model_gamm <- mgcv::gam(
  mpepr ~ s(spei_12m) + gdp_per_capita + s(year, bs = "re"),
  data = data,
  family = mgcv::betar(link = "logit")
)
```

```{r}
#| code-fold: false

summary(mpepr_model_gamm)
```

```{r}
summarise_r2(mpepr_model_gamm, n = nrow(data))
```

```{r}
#| code-fold: false

mpepr_model_gamm |> coef_mean()
```

```{r}
#| code-fold: false

mpepr_model_gamm |> coef_spei12m_mean()
```

```{r}
mpepr_model_gamm |> plot(pages = 1)
```

```{r}
mgcv::gam.check(mpepr_model_gamm)
```

```{r}
data |>
plot_gamm(
  model = mpepr_model_gamm,
  title = paste0(
    "Thinness for Height (MPEPR) versus \n",
    "Standardised Precipitation Evapotranspiration Index"
  ),
  y_label = "Predicted MPEPR"
)
```

## Analyzing Model Results by MISFS-R Clusters

::: {.callout-note}
See @carvalho2021a and @norde2023 to learn more about the Multidimensional Index for Sustainable Food Systems (MISFS).
:::

::: {#fig-norde-2023-figure-6}
![](images/norde-2023-figure-6.jpg){width=90%}

[Source: Reproduced from @norde2023.]{.legend}

Dendrogram for cluster analysis between Brazilian states considering all the Revised Multidimensional Index for Sustainable Food Systems (MISFS-R) indicators and geographical location of each cluster.
:::

### By S(SPEI 12m) + GDP Per Capita + S(Year)

#### MBEPR – Very Short Stature for Age (*Muito Baixa Estatura Para a Idade*)

```{r}
mbepr_model_gamm_misfs_1 <- 
  data |> 
  model_gamm_misfs(
    model = mbepr_model_gamm,
    type = 1
  )
```

```{r paged.print=FALSE}
#| code-fold: false

data |> summarise_model_gamm_misfs(mbepr_model_gamm_misfs_1)
```

```{r}
#| code-fold: false

mbepr_model_gamm_misfs_1 |> coef_means_misfs()
```

```{r}
#| code-fold: false

mbepr_model_gamm_misfs_1 |> coef_spei12m_means_misfs()
```

```{r}
data |>
  plot_gamm_misfs(
    gamm_models = mbepr_model_gamm_misfs_1,
    title = "Very Short Stature for Age (MBEPR) by MISFS",
    y_label = "Predicted MBEPR",
    type = 1
  )
```

#### BEIPR – Short Stature for Age (*Baixa Estatura Para Idade*)

```{r}
beipr_model_gamm_misfs_1 <- 
  data |> 
  model_gamm_misfs(
    model = beipr_model_gamm,
    type = 1
  )
```

```{r paged.print=FALSE}
#| code-fold: false

data |> summarise_model_gamm_misfs(beipr_model_gamm_misfs_1)
```

```{r}
#| code-fold: false

beipr_model_gamm_misfs_1 |> coef_means_misfs()
```

```{r}
#| code-fold: false

beipr_model_gamm_misfs_1 |> coef_spei12m_means_misfs()
```

```{r}
data |>
  plot_gamm_misfs(
    gamm_models = beipr_model_gamm_misfs_1,
    title = "Short Stature for Age (BEIPR) by MISFS",
    y_label = "Predicted BEIPR",
    type = 1
  )
```

#### MAPER – Severe Thinness for Height (*Magreza Acentuada Para a Estatura*)

```{r}
maper_model_gamm_misfs_1 <- 
  data |> 
  model_gamm_misfs(
    model = maper_model_gamm,
    type = 1
  )
```

```{r paged.print=FALSE}
#| code-fold: false

data |> summarise_model_gamm_misfs(maper_model_gamm_misfs_1)
```

```{r}
#| code-fold: false

maper_model_gamm_misfs_1 |> coef_means_misfs()
```

```{r}
#| code-fold: false

maper_model_gamm_misfs_1 |> coef_spei12m_means_misfs()
```

```{r}
data |>
  plot_gamm_misfs(
    gamm_models = maper_model_gamm_misfs_1,
    title = "Severe Thinness for Height (MAPER) by MISFS",
    y_label = "Predicted MAPER",
    type = 1
  )
```

#### MPEPR – Thinness for Height (*Magreza Por Estatura*)

```{r}
mpepr_model_gamm_misfs_1 <- 
  data |> 
  model_gamm_misfs(
    model = mpepr_model_gamm,
    type = 1
  )
```

```{r paged.print=FALSE}
#| code-fold: false

data |> summarise_model_gamm_misfs(mpepr_model_gamm_misfs_1)
```

```{r}
#| code-fold: false

mpepr_model_gamm_misfs_1 |> coef_means_misfs()
```

```{r}
#| code-fold: false

mpepr_model_gamm_misfs_1 |> coef_spei12m_means_misfs()
```

```{r}
data |>
  plot_gamm_misfs(
    gamm_models = mpepr_model_gamm_misfs_1,
    title = "Thinness for Height (MPEPR) by MISFS",
    y_label = "Predicted MPEPR",
    type = 1
  )
```

### Only by S(Year)

#### MBEPR – Very Short Stature for Age (*Muito Baixa Estatura Para a Idade*)

```{r}
mbepr_model_gamm_misfs_2 <- 
  data |> 
  model_gamm_misfs(
    model = mbepr_model_gamm,
    type = 2
  )
```

```{r paged.print=FALSE}
#| code-fold: false

data |> summarise_model_gamm_misfs(mbepr_model_gamm_misfs_2)
```

```{r}
#| code-fold: false

mbepr_model_gamm_misfs_2 |> coef_means_misfs()
```

```{r}
data |>
  plot_gamm_misfs(
    gamm_models = mbepr_model_gamm_misfs_2,
    title = "Very Short Stature for Age (MBEPR) by MISFS",
    x_label = "Years",
    y_label = "Predicted MBEPR",
    type = 2
  )
```

#### BEIPR – Short Stature for Age (*Baixa Estatura Para Idade*)

```{r}
beipr_model_gamm_misfs_2 <- 
  data |> 
  model_gamm_misfs(
    model = beipr_model_gamm,
    type = 2
  )
```

```{r paged.print=FALSE}
#| code-fold: false

data |> summarise_model_gamm_misfs(beipr_model_gamm_misfs_2)
```

```{r}
#| code-fold: false

beipr_model_gamm_misfs_2 |> coef_means_misfs()
```

```{r}
data |>
  plot_gamm_misfs(
    gamm_models = beipr_model_gamm_misfs_2,
    title = "Short Stature for Age (BEIPR) by MISFS",
    y_label = "Predicted BEIPR",
    type = 2
  )
```

#### MAPER – Severe Thinness for Height (*Magreza Acentuada Para a Estatura*)

```{r}
maper_model_gamm_misfs_2 <- 
  data |> 
  model_gamm_misfs(
    model = maper_model_gamm,
    type = 2
  )
```

```{r paged.print=FALSE}
#| code-fold: false

data |> summarise_model_gamm_misfs(maper_model_gamm_misfs_2)
```

```{r}
#| code-fold: false

maper_model_gamm_misfs_2 |> coef_means_misfs()
```

```{r}
data |>
  plot_gamm_misfs(
    gamm_models = maper_model_gamm_misfs_2,
    title = "Severe Thinness for Height (MAPER) by MISFS",
    y_label = "Predicted MAPER",
    type = 2
  )
```

#### MPEPR – Thinness for Height (*Magreza Por Estatura*)

```{r}
mpepr_model_gamm_misfs_2 <- 
  data |> 
  model_gamm_misfs(
    model = mpepr_model_gamm,
    type = 2
  )
```

```{r paged.print=FALSE}
#| code-fold: false

data |> summarise_model_gamm_misfs(mpepr_model_gamm_misfs_2)
```

```{r}
#| code-fold: false

mpepr_model_gamm_misfs_2 |> coef_means_misfs()
```

```{r}
data |>
  plot_gamm_misfs(
    gamm_models = mpepr_model_gamm_misfs_2,
    title = "Thinness for Height (MPEPR) by MISFS",
    y_label = "Predicted MPEPR",
    type = 2
  )
```

## Acknowledgments

![](images/sustentarea-icon-rgb-150-dpi.png){style="width: 17.5%;"}

This analysis is part of the [Sustentarea](https://www.fsp.usp.br/sustentarea) Research and Extension Group's project: *Global syndemic: the impact of anthropogenic climate change on the health and nutrition of children under five years old attended by Brazil's public health system (SUS)*.

![](images/cnpq-logo.png){style="width: 30%;"}

This research was supported by the Conselho Nacional de Desenvolvimento Científico e Tecnológico - Brazil ([CNPq](https://www.gov.br/cnpq/)).

## How to Cite

To cite this work, please use the following format:

Magalhães, A. R., Vartanian, D, & Carvalho, A. M. (2025). *Global syndemic project data analysis: Report 3: Exploring the association between childhood undernutrition and the Standardized Precipitation Evapotranspiration Index (SPEI) in Brazilian municipalities (2008–2019)*. Sustentarea Research and Extension Group at the University of São Paulo. https://sustentarea.github.io/gs-data-analysis-report-3

A BibTeX entry for LaTeX users is

```         
@techreport{magalhaes2025,
  title = {Global syndemic project data analysis: Report 3: Exploring the association between childhood undernutrition and the Standardized Precipitation Evapotranspiration Index (SPEI) in Brazilian municipalities (2008–2019)},
  author = {{Arthur Ramalho Magalhães} and {Daniel Vartanian} and {Aline Martins de Carvalho}},
  year = {2025},
  address = {São Paulo},
  institution = {Sustentarea Research and Extension Group at the University of São Paulo},
  langid = {en},
  url = {https://sustentarea.github.io/gs-data-analysis-report-3}
}
```

## References {.unnumbered}

::: {#refs}
:::
